#! /bin/ash

mount /proc
# Make dev a tmpfs directory
if ! grep -q devtmpfs /proc/mounts; then
    if grep -q devtmpfs /proc/filesystems; then
	mount -t devtmpfs none /dev
    else
	mount -t tmpfs none /dev
    fi
fi
echo /sbin/hotplug > /proc/sys/kernel/hotplug

# Create /dev/shm and /dev/pts for devtmpfs
mkdir -p /dev/shm /dev/pts
mount -a
mdev -s

if test ! -e /etc/ld.so.cache; then
    echo -n 'Running ldconfig...'
    ldconfig
    echo done
fi

# Update clock
if grep -q "root=/dev/nfs" /proc/cmdline; then
    rootserver=`dmesg | sed 's/^.*rootserver=\([^,]*\).*$/\1/;t;d'`
    if test -n "$rootserver"; then
	/usr/sbin/rdate -s "$rootserver"
    fi
fi

# Start log daemons
mkdir -p /var/log
syslogd -S -D -L
klogd

# Load modules
if test -e /usr/bin/keymap-chooser.sh; then
    modprobe xhci_hcd > /dev/null 2>&1
    modprobe ehci_hcd > /dev/null 2>&1
    find /sys -name modalias | while read f; do
	modprobe `cat $f` > /dev/null 2>&1 || :
    done
fi

# Start RAID
if test -e /sbin/mdadm; then
    /sbin/mdadm --assemble --scan
fi

# Start network
if ! ifconfig lo | grep -s UP > /dev/null 2>&1; then
    ifconfig lo 127.0.0.1 up
    ifconfig eth0 up 0.0.0.0
    udhcpc -abRS
fi

# Start telnet
telnetd

# Start ssh
if test -e /usr/sbin/dropbear; then
    ECDSA_KEY=/etc/dropbear/dropbear_ecdsa_host_key

    if test ! -e $ECDSA_KEY; then
	mkdir -p /etc/dropbear
	/usr/bin/dropbearkey -t ecdsa -f $ECDSA_KEY.tmp
	mv $ECDSA_KEY.tmp $ECDSA_KEY
	sync
    else
	/usr/bin/dropbearkey -y -f $ECDSA_KEY
    fi
    dropbear -B -R
fi

# Install ltp (old versions)
if test -e /ltp && test ! -e /ltp/.installed -o ! -e /ltp/testcases/bin/hackbench; then
    echo 'Installing LTP'
    dir=`pwd`
    cd /ltp
    make install && : > /ltp/.installed
    cd $dir
fi

if test -e /lib/modules/`uname -r`/modules.dep.bb; then
    rm /lib/modules/`uname -r`/modules.dep.bb
fi

chown root:0 /bin/ping
chmod u+sx /bin/ping

# Install default keymap if available
if test -e /etc/defkeymap.bin.xz; then
    echo Loading default keymap
    loadkeys defkeymap
elif test -e /usr/bin/keymap-chooser.sh; then
    dev=`sed 's/^.*console=\([^, ]*\).*$/\1/;t;s/.*/tty1/' /proc/cmdline`

    /usr/bin/keymap-chooser.sh < /dev/$dev > /dev/$dev 2> /dev/$dev
fi
